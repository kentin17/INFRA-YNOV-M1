# TP-04-02 : Automatisation de la création de ressources protégées

## Contexte
Après avoir automatisé la création de la structure de base du VPC, il est maintenant nécessaire de créer les ressources supplémentaires pour compléter l'architecture et sécuriser l'accès à l'infrastructure. Ce TP consiste à déployer des instances EC2 sécurisées dans le VPC existant (TP 02 - Exercice 2).

Les services cibles sont les suivants :
* Instance EC2 privée : destinée à héberger une application de partage de fichiers (Nextcloud), accessible uniquement en web depuis le VPN de l'entreprise.
* Instance EC2 publique (bastion) : permet d'établir une connexion SSH pour accéder à l'instance privée en rebond.

Les contraintes suivantes doivent être respectées :
* Les instances EC2 doivent être lancées à partir d'une image AMI Linux (distribution au choix).
* Les instances EC2 doivent être de type t3.micro.
* Les instances EC2 doivent être lancées dans le VPC créé pour cette infrastructure.
* Les instances EC2 doivent être nommées <username>-tp04-ex02-bastion et <username>-tp04-ex02-nextcloud ainsi que toutes leurs ressources associées.
* Chaque instance EC2 doit avoir sa propre paire de clé SSH.
* L'instance bastion doit être accessible en SSH depuis l'extérieur (Internet) via le port 22, uniquement depuis l'adresse IP publique de l'entreprise (ou celle de l'instance Cloud9).
* L'instance Nextcloud doit être accessible en SSH uniquement depuis l'instance bastion.
* Aucune ressource du VPC ne doit être accessible via EC2 Instance Connect, même si un security group l'autorise.



Structure des Fichiers : 
1. providers.tf : Définit le provider AWS.
2. locals.tf : Définit les variables locales pour les tags.
3. vpc-main.tf : Crée le VPC principal.
4. internet_gateway.tf : Configure la passerelle Internet.
5. subnets.tf : Configure les sous-réseaux publics et privés.
6. network_acl.tf : Configure les ACL réseau.
7. route_tables.tf : Configure les tables de routage et les associations pour les sous-réseaux publics.
8. security_groups.tf : Crée les groupes de sécurité pour le Bastion et Nextcloud.
9. instances.tf : Crée les instances EC2 pour le Bastion et Nextcloud.
10. output.tf : Affiche les informations des ressources déployées.



### 1. providers.tf
Définit le provider AWS avec les tags par défaut.
```bash
provider "aws" {
  profile = "formation-infra-cloud"
  region  = "eu-north-1"

  default_tags {
    tags = local.tags
  }
}
```

### 2. locals.tf
Définit les variables locales pour les tags.
```bash
locals {
  user = "qvos"
  tp   = basename(abspath(path.root))
  name = "${local.user}-${local.tp}"
  tags = {
    Name  = local.name
    Owner = local.user
  }
}
```

### 3. vpc-main.tf
Crée le VPC principal
```bash
resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"
  tags       = local.tags
}
```

### 4. internet_gateway.tf
Configure la passerelle Internet pour le VPC.
```bash
resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.main.id
  tags   = local.tags
}
```

### 5. subnets.tf
Définit les sous-réseaux publics et privés avec des adresses IP consécutives.
```bash
# Sous-réseaux publics
resource "aws_subnet" "public_subnet_a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.1.0/24"
  availability_zone = "eu-north-1a"
  map_public_ip_on_launch = true
  tags              = local.tags
}

resource "aws_subnet" "public_subnet_b" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.2.0/24"
  availability_zone = "eu-north-1b"
  map_public_ip_on_launch = true
  tags              = local.tags
}

resource "aws_subnet" "public_subnet_c" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.3.0/24"
  availability_zone = "eu-north-1c"
  map_public_ip_on_launch = true
  tags              = local.tags
}

# Sous-réseaux privés
resource "aws_subnet" "private_subnet_a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.4.0/24"
  availability_zone = "eu-north-1a"
  tags              = local.tags
}

resource "aws_subnet" "private_subnet_b" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.5.0/24"
  availability_zone = "eu-north-1b"
  tags              = local.tags
}

resource "aws_subnet" "private_subnet_c" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.6.0/24"
  availability_zone = "eu-north-1c"
  tags              = local.tags
}
```

